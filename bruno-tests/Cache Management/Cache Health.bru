meta {
  name: Cache Health
  type: http
  seq: 2
}

get {
  url: {{baseUrl}}/cache/health
  body: none
  auth: none
}

assert {
  res.status: in [200, 503]
  res.body: isJson
}

tests {
  test("Cache health response structure", function() {
    expect(res.getBody()).to.have.property('healthy');
    expect(res.getBody()).to.have.property('connected');
    expect(res.getBody()).to.have.property('timestamp');
  });

  test("Response has boolean healthy status", function() {
    expect(res.getBody().healthy).to.be.a('boolean');
  });

  test("Response has boolean connected status", function() {
    expect(res.getBody().connected).to.be.a('boolean');
  });

  test("Timestamp is recent", function() {
    const timestamp = res.getBody().timestamp;
    const now = Date.now();
    const fiveMinutesAgo = now - (5 * 60 * 1000);

    expect(timestamp).to.be.a('number');
    expect(timestamp).to.be.above(fiveMinutesAgo);
    expect(timestamp).to.be.below(now + 1000);
  });

  test("Status code matches health status", function() {
    if (res.getBody().healthy) {
      expect(res.getStatus()).to.equal(200);
    } else {
      expect(res.getStatus()).to.equal(503);
    }
  });

  test("Connected status matches healthy status", function() {
    if (res.getBody().healthy) {
      expect(res.getBody().connected).to.equal(true);
    }
  });

  test("Response time is reasonable", function() {
    expect(res.getResponseTime()).to.be.below(1000);
  });

  test("Content-Type is JSON", function() {
    expect(res.getHeader('content-type')).to.equal('application/json');
  });
}
